#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
tm_scale_bar(position=c("left", "bottom"),breaks = SCALE_BREAKS)+
#tm_text(text = "ISO_A2",size = 0.1) +
tm_borders(col = CHORO_BORDER_COL, lty = 1.1) +
tm_text('NAME',size = 0.65)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017)
# ---------------
# get yearly summary from 2007 to 2017 with diff (each YEAR)
# ---------------
gt_df_quart_sum_sub = subset( gt_df_quart_sum, gt_df_quart_sum$dateyy %in% c(2008, 2011, 2014, 2017) )
gt_df_quart_sum_yearly_diff = FUN_subgroups(gt_df_quart_sum_sub, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$period_years = paste0(lag(block$dateyy),'-',block$dateyy)
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
gt_df_quart_sum_yearly_diff = subset(gt_df_quart_sum_yearly_diff, gt_df_quart_sum_yearly_diff$dateyy != 2008)
gt_df_quart_sum_yearly_diff$low_search_volume = NULL
gt_df_quart_sum_yearly_diff$dateyy = NULL
gt_df_quart_sum_yearly_diff$period_years = as.factor(gt_df_quart_sum_yearly_diff$period_years)
#View(gt_df_quart_sum_yearly_diff)
writexl::write_xlsx(gt_df_quart_sum_yearly_diff,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_yearly.xlsx'))
# generate maps from gt_df_quart_sum_yearly_diff
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017,gt_df_quart_sum_10y,gt_df,gt_df_quart,gt_df_quart_diff)
# ------------
# Google trends over time within GM
# ------------
GT_DATA_FOLDER = 'data/NL_gtrends/NL_gtrends_2018-11-07/'
gt_df = readRDS( file = file.path(GT_DATA_FOLDER,'nl_gm_over_time_df.rds') )
gt_df$keyword = as.factor(gt_df$keyword)
gt_df$GTRENDS_MODE = as.factor(gt_df$GTRENDS_MODE)
names(gt_df)
summary(gt_df)
View(gt_df)
map_label = '[Growth map]'
length(unique(gt_df$date))
gt_df$datestr = substr( as.character(gt_df$date), 0, 7 )
gt_df$dateyy = as.factor(as.numeric( substr( as.character(gt_df$datestr), 0, 4 )))
gt_df$datemm = as.factor(substr( as.character(gt_df$datestr), 6, 7 ))
gt_df_quart = subset( gt_df, gt_df$datemm %in% c('01','04','07','10') )
gt_df_quart = subset( gt_df_quart, gt_df_quart$dateyy %in% c(2008, 2011, 2014, 2017) )
summary(gt_df_quart)
nrow(gt_df_quart)
View(gt_df_quart)
gt_df_quart_diff = FUN_subgroups(gt_df_quart, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'date')
block$hits_diff = lag( block$hits ) - block$hits
return(block)
})
# get yearly summary
gt_df = subset(gt_df,gt_df$low_search_volume==F)
gt_df_quart_sum = FUN_subgroups(gt_df, c('low_search_volume','GTRENDS_MODE','geo','dateyy','GEOUNIT_CODE'), function(block){
#print(nrow(block))
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
GEOUNIT_CODE = unique(block$GEOUNIT_CODE),
geo = unique(block$geo),
dateyy = unique(block$dateyy),
hits_sum = sum(block$hits),
hits_mean = round(mean(block$hits,rm.na = T),2)
)
return(row)
})
# ---------------
# get summary 2007 vs 2017 with diff (just one value)
# ---------------
gt_df_quart_sum_10y = subset(gt_df_quart_sum,gt_df_quart_sum$dateyy %in% c(2007,2017))
gt_df_quart_sum_diff = FUN_subgroups(gt_df_quart_sum_10y, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
stopifnot(nrow(block)==2)
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
rm(gt_df_quart_sum_10y)
gt_df_quart_sum_diff2017 = subset(gt_df_quart_sum_diff, gt_df_quart_sum_diff$dateyy == 2017)
#View(gt_df_quart_sum_diff2017)
writexl::write_xlsx(gt_df_quart_sum_diff2017,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_10years.xlsx'))
# generate growth maps showing 10 years difference
FUN_subgroups(gt_df_quart_sum_diff2017, c('low_search_volume','GTRENDS_MODE','geo'), function(block){
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo)
)
tit = paste(map_label,'low volume:',row$low_search_volume,'; mode:',row$GTRENDS_MODE,'; source:',row$geo,'; date: 2007-2017')
fn = paste0(OUT_DIR,'gm_trend_map-within-10y-',row$low_search_volume,'-',row$GTRENDS_MODE,'-',row$geo,'-diff_2007_2017.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <- add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
tm_scale_bar(position=c("left", "bottom"),breaks = SCALE_BREAKS)+
#tm_text(text = "ISO_A2",size = 0.1) +
tm_borders(col = CHORO_BORDER_COL, lty = 1.1) +
tm_text('NAME',size = 0.65)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017)
# ---------------
# get yearly summary from 2007 to 2017 with diff (each YEAR)
# ---------------
gt_df_quart_sum_sub = subset( gt_df_quart_sum, gt_df_quart_sum$dateyy %in% c(2008, 2011, 2014, 2017) )
gt_df_quart_sum_yearly_diff = FUN_subgroups(gt_df_quart_sum_sub, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$period_years = paste0(lag(block$dateyy),'-',block$dateyy)
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
gt_df_quart_sum_yearly_diff = subset(gt_df_quart_sum_yearly_diff, gt_df_quart_sum_yearly_diff$dateyy != 2008)
gt_df_quart_sum_yearly_diff$low_search_volume = NULL
gt_df_quart_sum_yearly_diff$dateyy = NULL
gt_df_quart_sum_yearly_diff$period_years = as.factor(gt_df_quart_sum_yearly_diff$period_years)
#View(gt_df_quart_sum_yearly_diff)
writexl::write_xlsx(gt_df_quart_sum_yearly_diff,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_yearly.xlsx'))
# generate maps from gt_df_quart_sum_yearly_diff
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-within-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017,gt_df_quart_sum_10y,gt_df,gt_df_quart,gt_df_quart_diff)
# ------------
# Google trends over time within GM
# ------------
GT_DATA_FOLDER = 'data/NL_gtrends/NL_gtrends_2018-11-07/'
gt_df = readRDS( file = file.path(GT_DATA_FOLDER,'nl_gm_over_time_df.rds') )
gt_df$keyword = as.factor(gt_df$keyword)
gt_df$GTRENDS_MODE = as.factor(gt_df$GTRENDS_MODE)
names(gt_df)
summary(gt_df)
View(gt_df)
map_label = '[Growth map]'
length(unique(gt_df$date))
gt_df$datestr = substr( as.character(gt_df$date), 0, 7 )
gt_df$dateyy = as.factor(as.numeric( substr( as.character(gt_df$datestr), 0, 4 )))
gt_df$datemm = as.factor(substr( as.character(gt_df$datestr), 6, 7 ))
gt_df_quart = subset( gt_df, gt_df$datemm %in% c('01','04','07','10') )
gt_df_quart = subset( gt_df_quart, gt_df_quart$dateyy %in% c(2008, 2011, 2014, 2017) )
summary(gt_df_quart)
nrow(gt_df_quart)
View(gt_df_quart)
gt_df_quart_diff = FUN_subgroups(gt_df_quart, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'date')
block$hits_diff = lag( block$hits ) - block$hits
return(block)
})
# get yearly summary
gt_df = subset(gt_df,gt_df$low_search_volume==F)
gt_df_quart_sum = FUN_subgroups(gt_df, c('low_search_volume','GTRENDS_MODE','geo','dateyy','GEOUNIT_CODE'), function(block){
#print(nrow(block))
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
GEOUNIT_CODE = unique(block$GEOUNIT_CODE),
geo = unique(block$geo),
dateyy = unique(block$dateyy),
hits_sum = sum(block$hits),
hits_mean = round(mean(block$hits,rm.na = T),2)
)
return(row)
})
# ---------------
# get summary 2007 vs 2017 with diff (just one value)
# ---------------
gt_df_quart_sum_10y = subset(gt_df_quart_sum,gt_df_quart_sum$dateyy %in% c(2007,2017))
gt_df_quart_sum_diff = FUN_subgroups(gt_df_quart_sum_10y, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
stopifnot(nrow(block)==2)
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
rm(gt_df_quart_sum_10y)
gt_df_quart_sum_diff2017 = subset(gt_df_quart_sum_diff, gt_df_quart_sum_diff$dateyy == 2017)
#View(gt_df_quart_sum_diff2017)
writexl::write_xlsx(gt_df_quart_sum_diff2017,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_10years.xlsx'))
# generate growth maps showing 10 years difference
FUN_subgroups(gt_df_quart_sum_diff2017, c('low_search_volume','GTRENDS_MODE','geo'), function(block){
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo)
)
tit = paste(map_label,'low volume:',row$low_search_volume,'; mode:',row$GTRENDS_MODE,'; source:',row$geo,'; date: 2007-2017')
fn = paste0(OUT_DIR,'gm_trend_map-within-10y-',row$low_search_volume,'-',row$GTRENDS_MODE,'-',row$geo,'-diff_2007_2017.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <- add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
tm_scale_bar(position=c("left", "bottom"),breaks = SCALE_BREAKS)+
#tm_text(text = "ISO_A2",size = 0.1) +
tm_borders(col = CHORO_BORDER_COL, lty = 1.1) +
tm_text('NAME',size = 0.65)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017)
# ---------------
# get yearly summary from 2007 to 2017 with diff (each YEAR)
# ---------------
gt_df_quart_sum_sub = subset( gt_df_quart_sum, gt_df_quart_sum$dateyy %in% c(2008, 2011, 2014, 2017) )
gt_df_quart_sum_yearly_diff = FUN_subgroups(gt_df_quart_sum_sub, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$period_years = paste0(lag(block$dateyy),'-',block$dateyy)
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
gt_df_quart_sum_yearly_diff = subset(gt_df_quart_sum_yearly_diff, gt_df_quart_sum_yearly_diff$dateyy != 2008)
gt_df_quart_sum_yearly_diff$low_search_volume = NULL
gt_df_quart_sum_yearly_diff$dateyy = NULL
gt_df_quart_sum_yearly_diff$period_years = as.factor(gt_df_quart_sum_yearly_diff$period_years)
#View(gt_df_quart_sum_yearly_diff)
writexl::write_xlsx(gt_df_quart_sum_yearly_diff,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_yearly.xlsx'))
# generate maps from gt_df_quart_sum_yearly_diff
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-within-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017,gt_df_quart_sum_10y,gt_df,gt_df_quart,gt_df_quart_diff)
# ------------
# Google trends over time within GM
# ------------
GT_DATA_FOLDER = 'data/NL_gtrends/NL_gtrends_2018-11-07/'
gt_df = readRDS( file = file.path(GT_DATA_FOLDER,'nl_gm_over_time_df.rds') )
gt_df$keyword = as.factor(gt_df$keyword)
gt_df$GTRENDS_MODE = as.factor(gt_df$GTRENDS_MODE)
names(gt_df)
summary(gt_df)
View(gt_df)
map_label = '[Growth map]'
length(unique(gt_df$date))
gt_df$datestr = substr( as.character(gt_df$date), 0, 7 )
gt_df$dateyy = as.factor(as.numeric( substr( as.character(gt_df$datestr), 0, 4 )))
gt_df$datemm = as.factor(substr( as.character(gt_df$datestr), 6, 7 ))
gt_df_quart = subset( gt_df, gt_df$datemm %in% c('01','04','07','10') )
gt_df_quart = subset( gt_df_quart, gt_df_quart$dateyy %in% c(2008, 2011, 2014, 2017) )
summary(gt_df_quart)
nrow(gt_df_quart)
View(gt_df_quart)
gt_df_quart_diff = FUN_subgroups(gt_df_quart, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'date')
block$hits_diff = lag( block$hits ) - block$hits
return(block)
})
# get yearly summary
gt_df = subset(gt_df,gt_df$low_search_volume==F)
gt_df_quart_sum = FUN_subgroups(gt_df, c('low_search_volume','GTRENDS_MODE','geo','dateyy','GEOUNIT_CODE'), function(block){
#print(nrow(block))
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
GEOUNIT_CODE = unique(block$GEOUNIT_CODE),
geo = unique(block$geo),
dateyy = unique(block$dateyy),
hits_sum = sum(block$hits),
hits_mean = round(mean(block$hits,rm.na = T),2)
)
return(row)
})
# ---------------
# get summary 2007 vs 2017 with diff (just one value)
# ---------------
gt_df_quart_sum_10y = subset(gt_df_quart_sum,gt_df_quart_sum$dateyy %in% c(2007,2017))
gt_df_quart_sum_diff = FUN_subgroups(gt_df_quart_sum_10y, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
stopifnot(nrow(block)==2)
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
rm(gt_df_quart_sum_10y)
gt_df_quart_sum_diff2017 = subset(gt_df_quart_sum_diff, gt_df_quart_sum_diff$dateyy == 2017)
#View(gt_df_quart_sum_diff2017)
writexl::write_xlsx(gt_df_quart_sum_diff2017,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_10years.xlsx'))
# generate growth maps showing 10 years difference
FUN_subgroups(gt_df_quart_sum_diff2017, c('low_search_volume','GTRENDS_MODE','geo'), function(block){
row = data.frame(
low_search_volume = unique(block$low_search_volume),
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo)
)
tit = paste(map_label,'low volume:',row$low_search_volume,'; mode:',row$GTRENDS_MODE,'; source:',row$geo,'; date: 2007-2017')
fn = paste0(OUT_DIR,'gm_trend_map-within-10y-',row$low_search_volume,'-',row$GTRENDS_MODE,'-',row$geo,'-diff_2007_2017.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <- add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="equal", palette=DIV_PALETTE, n = 5,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
tm_scale_bar(position=c("left", "bottom"),breaks = SCALE_BREAKS)+
#tm_text(text = "ISO_A2",size = 0.1) +
tm_borders(col = CHORO_BORDER_COL, lty = 1.1) +
tm_text('NAME',size = 0.65)
save_tmap(gtrends_map,fn)
})
rm(gt_df_quart_sum_diff2017)
# ---------------
# get yearly summary from 2007 to 2017 with diff (each YEAR)
# ---------------
gt_df_quart_sum_sub = subset( gt_df_quart_sum, gt_df_quart_sum$dateyy %in% c(2008, 2011, 2014, 2017) )
gt_df_quart_sum_yearly_diff = FUN_subgroups(gt_df_quart_sum_sub, c('low_search_volume','GTRENDS_MODE','geo','GEOUNIT_CODE'), function(block){
#print(nrow(block))
block = sort_df(block,'dateyy')
block$hits_sum_diff = block$hits_sum - lag( block$hits_sum )
block$period_years = paste0(lag(block$dateyy),'-',block$dateyy)
block$hits_sum_diff_pc = round((block$hits_sum_diff / lag( block$hits_sum))*100,2)
return(block)
})
gt_df_quart_sum_yearly_diff = subset(gt_df_quart_sum_yearly_diff, gt_df_quart_sum_yearly_diff$dateyy != 2008)
gt_df_quart_sum_yearly_diff$low_search_volume = NULL
gt_df_quart_sum_yearly_diff$dateyy = NULL
gt_df_quart_sum_yearly_diff$period_years = as.factor(gt_df_quart_sum_yearly_diff$period_years)
#View(gt_df_quart_sum_yearly_diff)
writexl::write_xlsx(gt_df_quart_sum_yearly_diff,paste0(OUT_DIR,'gt_gm_withingm_sum_diff_yearly.xlsx'))
# generate maps from gt_df_quart_sum_yearly_diff
bin_breaks = classIntervals(gt_df_quart_sum_yearly_diff$hits_sum_diff_pc, 4, style = 'quantile')$brks
TODO
bin_breaks
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-within-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="fixed", palette=DIV_PALETTE,
#n = 5,
breaks = bin_breaks,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
bin_breaks = classIntervals(gt_df_quart_sum_yearly_diff$hits_sum_diff_pc, 5, style = 'quantile')$brks
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-within-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="fixed", palette=DIV_PALETTE,
#n = 5,
breaks = bin_breaks,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
bin_breaks = classIntervals(gt_df_quart_sum_yearly_diff$hits_sum_diff_pc, 5, style = 'quantile')$brks
bin_breaks
#bin_breaks = classIntervals(gt_df_quart_sum_yearly_diff$hits_sum_diff_pc, 5, style = 'quantile')$brks
bin_breaks = c(-65 -15  -5  5   15  65)
#bin_breaks = classIntervals(gt_df_quart_sum_yearly_diff$hits_sum_diff_pc, 5, style = 'quantile')$brks
bin_breaks = c(-65, -15,  -5,  5,   15,  65)
FUN_subgroups(gt_df_quart_sum_yearly_diff, c('GTRENDS_MODE','geo','period_years'), function(block){
row = data.frame(
GTRENDS_MODE = unique(block$GTRENDS_MODE),
geo = unique(block$geo),
period_years = unique(block$period_years)
)
tit = paste(map_label,'mode:',row$GTRENDS_MODE,'; source:',row$geo,'; period:', row$period_years)
fn = paste0(OUT_DIR,'gm_trend_map-within-','-',row$GTRENDS_MODE,'-',row$geo,
'--',row$period_years,'.pdf')
print(fn)
print(nrow(block))
stopifnot(nrow(ams_gm_sdf_simpl)==nrow(block))
gm_gtrends_sdf = merge(ams_gm_sdf_simpl, block, by.x='CODE', by.y='GEOUNIT_CODE', all.x=T)
gtrends_map <-
add_nl_basemap(gm_gtrends_sdf) +
tm_shape(gm_gtrends_sdf) +
tm_fill(col="hits_sum_diff_pc", style="fixed", palette=DIV_PALETTE,
#n = 5,
breaks = bin_breaks,
legend.format=list(list(digits=0))) + #quantile ,
#tm_scale_bar(width=0.15,position=c("left","bottom")) +
#tm_credits("\n\n\n\n\nContains data from Office for National Statistics\nand Ordnance Survey. Crown copyright & database right 2016.",size=0.6,position=c("left","bottom")) +
tm_layout(frame=FALSE,title = tit,legend.position = c('right','bottom'), title.size = 1) + tm_legend(scale=0.75) +
#tm_text(text = "ISO_A2",size = 0.1) +
my_scale_bar() +
tm_borders(col = 'white',lty = 1.1)
save_tmap(gtrends_map,fn)
})
